{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white text-center py-3 rounded-top-4">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Increment Details
                    </h4>
                </div>
                
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h5>{{ employee.full_name }}</h5>
                        <p class="text-muted">{{ employee.employee_id }} | {{ employee.designation }}</p>
                        <p class="text-muted">Current CTC: ₹{{ "{:,.2f}".format(employee.ctc) }}</p>
                    </div>
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form action="{{ url_for('admin_generate_document', emp_id=employee.id, doc_type='increment_letter') }}" method="POST">
                        <!-- Company Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Select Company</label>
                            <select class="form-select" name="company" required>
                                <option value="">-- Select Company --</option>
                                {% for company in companies %}
                                <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Increment Amount -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Increment Amount (per month) *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" 
                                       class="form-control form-control-lg" 
                                       name="increment_amount" 
                                       step="0.01" 
                                       min="1"
                                       placeholder="Enter increment amount"
                                       required>
                            </div>
                            <small class="text-muted">Enter the monthly increment amount (e.g., 5000)</small>
                        </div>
                        
                        <!-- Effective Date -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Effective Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   name="effective_date" 
                                   value="{{ now().strftime('%Y-%m-%d') if now else '' }}"
                                   required>
                            <small class="text-muted">Date from which increment will be effective</small>
                        </div>
                        
                        <!-- New CTC Preview -->
                        <div class="alert alert-info" data-current-ctc="{{ employee.ctc|float }}">
                            <strong>New Annual CTC:</strong> 
                            ₹{{ "{:,.2f}".format(employee.ctc) }} + (increment × 12)
                            <br>
                            <span id="newCtcPreview">Enter increment amount to see new CTC</span>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                                <i class="fas fa-file-pdf me-2"></i>Generate Increment Letter
                            </button>
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary rounded-pill">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Live preview of new CTC
    document.addEventListener('DOMContentLoaded', function() {
        const incrementInput = document.querySelector('input[name="increment_amount"]');
        if (incrementInput) {
            incrementInput.addEventListener('input', function(e) {
                // Get current CTC as a number (from data attribute to avoid Jinja2 issues)
                const currentCTC = parseFloat(document.querySelector('.alert-info').dataset.currentCtc);
                const increment = parseFloat(e.target.value) || 0;
                const newCTC = currentCTC + (increment * 12);
                
                // Format the number for display
                const formattedCTC = newCTC.toLocaleString('en-IN', {
                    maximumFractionDigits: 2,
                    minimumFractionDigits: 2
                });
                
                document.getElementById('newCtcPreview').innerHTML = 
                    `New Annual CTC: <strong>₹${formattedCTC}</strong>`;
            });
        }
    });
</script>
{% endblock %}