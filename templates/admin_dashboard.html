{% extends "base.html" %}

{% block content %}
<style>
    .employee-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .employee-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }
    
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        position: relative;
    }
    
    .employee-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid white;
        object-fit: cover;
        margin: 0 auto 10px;
        display: block;
    }
    
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-active {
        background-color: #28a745;
        color: white;
    }
    
    .status-resigned {
        background-color: #dc3545;
        color: white;
    }
    
    .status-terminated {
        background-color: #6c757d;
        color: white;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-label {
        color: #6c757d;
        font-weight: 500;
    }
    
    .info-value {
        font-weight: 600;
        color: #333;
    }
    
    .document-badge {
        background-color: #e9ecef;
        border-radius: 20px;
        padding: 2px 10px;
        font-size: 12px;
        color: #495057;
    }
    
    .action-btn {
        width: 100%;
        margin: 5px 0;
        border-radius: 8px;
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        transform: scale(1.02);
    }
    
    .btn-offer {
        background-color: #4e73df;
        color: white;
    }
    
    .btn-salary {
        background-color: #1cc88a;
        color: white;
    }
    
    .btn-experience {
        background-color: #36b9cc;
        color: white;
    }
    
    .btn-increment {
        background-color: #f6c23e;
        color: white;
    }
    
    .btn-relieving {
        background-color: #e74a3b;
        color: white;
    }
    
    .filter-bar {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stats-number {
        font-size: 32px;
        font-weight: bold;
    }
    
    .stats-label {
        font-size: 14px;
        opacity: 0.9;
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üë• Employee Dashboard</h2>
        <div>
            <a href="{{ url_for('add_employee') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Employee
            </a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ employees|length }}</div>
                <div class="stats-label">Total Employees</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);">
                <div class="stats-number">
                    {{ employees|selectattr('employee.status', 'equalto', 'active')|list|length }}
                </div>
                <div class="stats-label">Active Employees</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);">
                <div class="stats-number">
                    {{ employees|sum(attribute='document_count') }}
                </div>
                <div class="stats-label">Total Documents</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);">
                <div class="stats-number">
                    {{ employees|selectattr('employee.joining_date', 'ge', now.replace(day=1, month=1).date())|list|length }}
                </div>
                <div class="stats-label">Joined This Year</div>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchInput" 
                       placeholder="üîç Search by name, ID, or designation...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="resigned">Resigned</option>
                    <option value="terminated">Terminated</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="departmentFilter">
                    <option value="all">All Departments</option>
                    {% set departments = [] %}
                    {% for item in employees %}
                        {% if item.employee.department and item.employee.department not in departments %}
                            {% set departments = departments.append(item.employee.department) %}
                            <option value="{{ item.employee.department }}">{{ item.employee.department }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-secondary w-100" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Cards Grid -->
    <div class="row" id="employeeGrid">
        {% for item in employees %}
        <div class="col-xl-4 col-lg-6 col-md-6 mb-4 employee-card-wrapper" 
             data-name="{{ item.employee.full_name|lower }}"
             data-id="{{ item.employee.employee_id|lower }}"
             data-designation="{{ item.employee.designation|lower }}"
             data-status="{{ item.employee.status }}"
             data-department="{{ item.employee.department|lower }}">
            <div class="card employee-card h-100">
                <!-- Card Header with Avatar -->
                <div class="card-header text-center">
                    <span class="status-badge status-{{ item.employee.status }}">
                        {{ item.employee.status|upper }}
                    </span>
                    
                    {% if item.employee.profile_image %}
                        <img src="{{ url_for('serve_profile_image', filename=item.employee.profile_image) }}" 
                             class="employee-avatar" alt="{{ item.employee.full_name }}">
                    {% else %}
                        <div class="employee-avatar" style="background: #6c757d; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white;">
                            {{ item.employee.full_name[:1] }}
                        </div>
                    {% endif %}
                    
                    <h5 class="mt-2 mb-0 text-white">{{ item.employee.full_name }}</h5>
                    <p class="text-white-50 mb-0">{{ item.employee.employee_id }}</p>
                </div>
                
                <!-- Card Body -->
                <div class="card-body">
                    <!-- Employee Info -->
                    <div class="info-row">
                        <span class="info-label">üìß Email</span>
                        <span class="info-value">{{ item.employee.email or 'N/A' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">üì± Phone</span>
                        <span class="info-value">{{ item.employee.phone or 'N/A' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">üíº Designation</span>
                        <span class="info-value">{{ item.employee.designation }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">üè¢ Department</span>
                        <span class="info-value">{{ item.employee.department or 'N/A' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">üí∞ CTC</span>
                        <span class="info-value">‚Çπ{{ "{:,.0f}".format(item.employee.ctc) }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">üìà Current Increment</span>
                        <span class="info-value text-success">
                            {% if item.employee.increment_per_month and item.employee.increment_per_month > 0 %}
                                +‚Çπ{{ "{:,.0f}".format(item.employee.increment_per_month) }}/month
                            {% else %}
                                <span class="text-muted">No increment</span>
                            {% endif %}
                        </span>
                    </div>

                    <!-- Also show projected new CTC if there's an increment -->
                    {% if item.employee.increment_per_month and item.employee.increment_per_month > 0 %}
                    <div class="info-row">
                        <span class="info-label">üìä Projected New CTC</span>
                        <span class="info-value text-primary">
                            ‚Çπ{{ "{:,.0f}".format(item.employee.ctc + (item.employee.increment_per_month * 12)) }}
                        </span>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <span class="info-label">üìÖ Joining Date</span>
                        <span class="info-value">
                            {% if item.employee.joining_date %}
                                {{ item.employee.joining_date.strftime('%d %b %Y') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Document Count -->
                    <div class="text-center mt-3">
                        <span class="document-badge">
                            üìÑ {{ item.document_count }} Documents Generated
                        </span>
                    </div>
                    
                    <!-- Document Generation Buttons -->
                    <div class="mt-3">
                        <small class="text-muted d-block mb-2">Generate Documents:</small>
                        <div class="row g-2">
                            <div class="col-6">
                                <form action="{{ url_for('admin_generate_document', emp_id=item.employee.id, doc_type='offer_letter') }}" method="POST" target="_blank">
                                    <button type="submit" class="btn action-btn btn-offer btn-sm w-100">
                                        üìÑ Offer Letter
                                    </button>
                                </form>
                            </div>
                            <div class="col-6">
                                <form action="{{ url_for('admin_generate_document', emp_id=item.employee.id, doc_type='salary_slip') }}" method="GET">
                                    <button type="submit" class="btn action-btn btn-salary btn-sm w-100">
                                        üí∞ Salary Slip
                                    </button>
                                </form>
                            </div>
                            <div class="col-6">
                                <form action="{{ url_for('admin_generate_document', emp_id=item.employee.id, doc_type='experience_letter') }}" method="POST">
                                    <button type="submit" class="btn action-btn btn-experience btn-sm w-100">
                                        üéì Experience
                                    </button>
                                </form>
                            </div>
                            <div class="col-6">
                                <form action="{{ url_for('admin_generate_document', emp_id=item.employee.id, doc_type='increment_letter') }}" method="POST">
                                    <button type="submit" class="btn action-btn btn-increment btn-sm w-100">
                                        üìà Increment
                                    </button>
                                </form>
                            </div>
                            <div class="col-6">
                                <form action="{{ url_for('admin_generate_document', emp_id=item.employee.id, doc_type='relieving_letter') }}" method="POST">
                                    <button type="submit" class="btn action-btn btn-relieving btn-sm w-100">
                                        üö™ Relieving
                                    </button>
                                </form>
                            </div>
                            <div class="col-6">
                                <a href="{{ url_for('view_employee', emp_id=item.employee.id) }}" class="btn action-btn btn-secondary btn-sm w-100">
                                    üëÅÔ∏è View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- JavaScript for Filtering -->
<script>
    function filterEmployees() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const departmentFilter = document.getElementById('departmentFilter').value.toLowerCase();
        
        const cards = document.querySelectorAll('.employee-card-wrapper');
        
        cards.forEach(card => {
            const name = card.dataset.name;
            const empId = card.dataset.id;
            const designation = card.dataset.designation;
            const status = card.dataset.status;
            const department = card.dataset.department;
            
            const matchesSearch = searchTerm === '' || 
                name.includes(searchTerm) || 
                empId.includes(searchTerm) || 
                designation.includes(searchTerm);
            
            const matchesStatus = statusFilter === 'all' || status === statusFilter;
            const matchesDepartment = departmentFilter === 'all' || department === departmentFilter;
            
            if (matchesSearch && matchesStatus && matchesDepartment) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('departmentFilter').value = 'all';
        filterEmployees();
    }
    
    // Add event listeners
    document.getElementById('searchInput').addEventListener('keyup', filterEmployees);
    document.getElementById('statusFilter').addEventListener('change', filterEmployees);
    document.getElementById('departmentFilter').addEventListener('change', filterEmployees);
</script>
{% endblock %}